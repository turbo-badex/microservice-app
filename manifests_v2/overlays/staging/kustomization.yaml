apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: microservice-app-staging

# Reference the base configuration components
resources:
- ../../base
- ../../auth-service
- ../../game-service
- ../../frontend
- namespace.yaml
- postgres-cluster.yaml
- sealed-dockerhub-secret.yaml
- sealed-auth-service-secret.yaml
- sealed-game-service-secret.yaml

# Override namespace for staging environment
namespace: microservice-app-staging

# Labels for staging environment
# Note: includeSelectors=false to avoid adding environment label to network policy selectors
# (CNPG-created pods don't automatically inherit the environment label)
labels:
- includeSelectors: false
  pairs:
    environment: staging

# Common annotations
commonAnnotations:
  app.kubernetes.io/environment: staging

# Image tags for staging (use staging-specific tags)
images:
- name: badex/auth-service
  newTag: staging
- name: badex/frontend
  newTag: staging
- name: badex/game-service
  newTag: staging

# Patches for staging-specific configurations
  # 2 replicas for staging (same as base)
  # Strategic merge patch for CNPG secret references
patches:
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 2
  target:
    kind: Deployment
- path: cnpg-secret-patch.yaml

# ConfigMap overrides for staging
configMapGenerator:
- behavior: merge
  literals:
  - POSTGRES_HOST=postgres-staging-rw
  - POSTGRES_DB=gamedb
  - FLASK_ENV=staging
  - LOG_LEVEL=info
  name: auth-service-config
- behavior: merge
  literals:
  - POSTGRES_HOST=postgres-staging-rw
  - POSTGRES_DB=gamedb
  - FLASK_ENV=staging
  - LOG_LEVEL=info
  name: game-service-config

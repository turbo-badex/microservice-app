apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: microservice-app-dev

# Reference the base configuration components
resources:
- ../../base
- ../../auth-service
- ../../game-service
- ../../frontend
- namespace.yaml
- postgres-cluster.yaml
- sealed-dockerhub-secret.yaml
- sealed-auth-service-secret.yaml
- sealed-game-service-secret.yaml

# Override namespace for dev environment
namespace: microservice-app-dev

# Labels for dev environment
labels:
- includeSelectors: true
  pairs:
    environment: dev

# Common annotations
commonAnnotations:
  app.kubernetes.io/environment: development

# Image tags for dev (use latest or dev-specific tags)
images:
- name: badex/auth-service
  newTag: dev
- name: badex/frontend
  newTag: dev
- name: badex/game-service
  newTag: dev

# Patches for dev-specific configurations
  # Reduce replicas and resources in dev
  # Strategic merge patch for CNPG secret references
patches:
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: "10m"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "32Mi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: "100m"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "128Mi"
  target:
    kind: Deployment
- path: cnpg-secret-patch.yaml

# ConfigMap overrides for dev
configMapGenerator:
- behavior: merge
  literals:
  - POSTGRES_HOST=postgres-dev-rw
  - POSTGRES_DB=gamedb
  - FLASK_ENV=development
  - LOG_LEVEL=debug
  name: auth-service-config
- behavior: merge
  literals:
  - POSTGRES_HOST=postgres-dev-rw
  - POSTGRES_DB=gamedb
  - FLASK_ENV=development
  - LOG_LEVEL=debug
  name: game-service-config

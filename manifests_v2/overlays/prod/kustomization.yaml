apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: microservice-app-prod

# Reference the base configuration components
resources:
- ../../base
- ../../auth-service
- ../../game-service
- ../../frontend
- namespace.yaml
- postgres-cluster.yaml
- hpa.yaml
- sealed-dockerhub-secret.yaml
- sealed-auth-service-secret.yaml
- sealed-game-service-secret.yaml

# Override namespace for production environment
namespace: microservice-app-prod

# Labels for production environment
labels:
- includeSelectors: true
  pairs:
    environment: prod

# Common annotations
commonAnnotations:
  app.kubernetes.io/environment: production

# Image tags for production (use specific version tags, not latest)
images:
- name: badex/auth-service
  newTag: v1.0.0
- name: badex/frontend
  newTag: 1.1.3
- name: badex/game-service
  newTag: v1.0.0

# Patches for production-specific configurations
  # Increase replicas for production
  # Increase resource limits for production
  # Strategic merge patch for CNPG secret references
patches:
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 3
  target:
    kind: Deployment
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 128Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 500m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 256Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1000m
  target:
    kind: Deployment
    name: auth-service
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 128Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 500m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 256Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1000m
  target:
    kind: Deployment
    name: game-service
- path: cnpg-secret-patch.yaml

# ConfigMap overrides for production
configMapGenerator:
- behavior: merge
  literals:
  - POSTGRES_HOST=postgres-prod-rw
  - POSTGRES_DB=gamedb
  - FLASK_ENV=production
  - LOG_LEVEL=warning
  - GUNICORN_WORKERS=8
  name: auth-service-config
- behavior: merge
  literals:
  - POSTGRES_HOST=postgres-prod-rw
  - POSTGRES_DB=gamedb
  - FLASK_ENV=production
  - LOG_LEVEL=warning
  - GUNICORN_WORKERS=8
  name: game-service-config
